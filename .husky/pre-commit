#!/bin/sh

# RateWise Pre-commit Hook
# [BDD:2025-12-01] æ•´åˆå®Œæ•´å“è³ªæª¢æŸ¥åˆ° Git workflow
# [CI:2025-12-01] é˜²æ­¢ CI å¤±æ•—çš„æ ¹æœ¬åŸå› 
# [SSOT:2026-01-06] æ–°å¢ SSOT åŒæ­¥é©—è­‰

echo "ğŸ” åŸ·è¡Œ Pre-commit æª¢æŸ¥..."

# 1. Lint-staged (ç¨‹å¼ç¢¼æ ¼å¼åŒ–èˆ‡ Lint)
echo "\nğŸ“‹ Step 1/4: Lint-staged..."
pnpm lint-staged
if [ $? -ne 0 ]; then
  echo "\nâŒ Lint-staged å¤±æ•—ï¼Œè«‹ä¿®å¾©å¾Œå†æäº¤"
  exit 1
fi

# 2. TypeScript æª¢æŸ¥ (å¿«é€Ÿé©—è­‰é¡å‹éŒ¯èª¤)
echo "\nğŸ“‹ Step 2/4: TypeScript æª¢æŸ¥..."
pnpm typecheck
if [ $? -ne 0 ]; then
  echo "\nâŒ TypeScript æª¢æŸ¥å¤±æ•—ï¼Œè«‹ä¿®å¾©é¡å‹éŒ¯èª¤å¾Œå†æäº¤"
  exit 1
fi

# 3. æ ¼å¼æª¢æŸ¥ (ç¢ºä¿æ‰€æœ‰æ–‡ä»¶å·²æ ¼å¼åŒ–)
echo "\nğŸ“‹ Step 3/4: Prettier æ ¼å¼æª¢æŸ¥..."
pnpm format
if [ $? -ne 0 ]; then
  echo "\nâŒ æ ¼å¼æª¢æŸ¥å¤±æ•—ï¼Œè«‹åŸ·è¡Œ 'pnpm format:fix' å¾Œå†æäº¤"
  exit 1
fi

# 4. SSOT åŒæ­¥é©—è­‰ (ç¢ºä¿ SEO é…ç½®ä¸€è‡´æ€§)
# [å¯é¸] åƒ…åœ¨ ratewise ç›¸é—œæª”æ¡ˆæœ‰è®Šæ›´æ™‚åŸ·è¡Œ
if git diff --cached --name-only | grep -qE "(seo-paths|app\.config)"; then
  echo "\nğŸ“‹ Step 4/4: SSOT åŒæ­¥é©—è­‰..."
  node scripts/verify-ssot-sync.mjs 2>/dev/null
  if [ $? -ne 0 ]; then
    echo "\nâŒ SSOT åŒæ­¥é©—è­‰å¤±æ•—ï¼Œè«‹ç¢ºä¿ seo-paths.config.mjs èˆ‡ seo-paths.ts ä¸€è‡´"
    exit 1
  fi
else
  echo "\nğŸ“‹ Step 4/4: SSOT åŒæ­¥é©—è­‰ (è·³é - ç„¡ç›¸é—œè®Šæ›´)"
fi

echo "\nâœ… æ‰€æœ‰ Pre-commit æª¢æŸ¥é€šé"
