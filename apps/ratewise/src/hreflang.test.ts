/**
 * Hreflang Configuration BDD Tests - SEO Phase 2A-3
 *
 * BDD æ¸¬è©¦ï¼šé©—è­‰ Hreflang é…ç½®æ­£ç¢ºæ€§
 *
 * æ¸¬è©¦ç­–ç•¥ï¼š
 * - ğŸ”´ sitemap.xml ä¸æ‡‰è©²åŒ…å« hreflang="en"ï¼ˆæ‡‰ç”¨æ²’æœ‰è‹±æ–‡ç‰ˆæœ¬ï¼‰
 * - ğŸ”´ sitemap.xml æ‡‰è©²åªæœ‰ zh-TW å’Œ x-default
 * - ğŸ”´ SEOHelmet fallback alternates ä¸æ‡‰è©²åŒ…å«è‹±æ–‡ locale
 * - ğŸ”´ SEOHelmet ä¸æ‡‰è©²ç‚ºå–®ä¸€èªè¨€ç”Ÿæˆ og:locale:alternate
 *
 * [fix:2025-12-31] sitemap.xml ç¾åœ¨ç”± vite-ssg-sitemap åœ¨ build æ™‚è‡ªå‹•ç”Ÿæˆåˆ° dist/
 * æ¸¬è©¦æ”¹ç‚ºé©—è­‰ SEOHelmet é…ç½®æ­£ç¢ºæ€§ï¼ˆsitemap é©—è­‰ç§»è‡³ CI pipelineï¼‰
 *
 * åƒè€ƒï¼šfix/seo-phase2a-bdd-approach
 * ä¾æ“šï¼š[SEO å¯©æŸ¥å ±å‘Š 2025-11-25] Hreflang é…ç½®éŒ¯èª¤å•é¡Œ
 */

import { describe, it, expect } from 'vitest';
import { readFileSync, existsSync } from 'node:fs';
import { resolve } from 'node:path';

describe('Hreflang Configuration (BDD)', () => {
  describe('ğŸ”´ RED: sitemap.xml Hreflang é…ç½®', () => {
    // sitemap.xml is auto-generated by vite-ssg-sitemap; hreflang provided via SEOHelmet
    // é€™äº›æ¸¬è©¦é©—è­‰ sitemap.xml ä¸åŒ…å«éŒ¯èª¤çš„ hreflang é…ç½®
    const distSitemapPath = resolve(__dirname, '../dist/sitemap.xml');
    const sitemapExists = existsSync(distSitemapPath);

    // æª¢æŸ¥æ˜¯å¦ç‚ºæ­£ç¢ºçš„ ratewise buildï¼ˆURL æ‡‰åŒ…å« /ratewise/ï¼‰
    const isRatewiseBuild =
      sitemapExists && readFileSync(distSitemapPath, 'utf-8').includes('haotool.org/ratewise/');

    it('should NOT contain hreflang="en" (no English version exists)', () => {
      if (!sitemapExists || !isRatewiseBuild) {
        // sitemap åœ¨ build æ™‚ç”Ÿæˆï¼Œè·³éæ­¤æ¸¬è©¦
        console.log('â­ï¸ Skipping: ratewise sitemap.xml not found (generated during build)');
        return;
      }
      const sitemapContent = readFileSync(distSitemapPath, 'utf-8');
      // ğŸ”´ ç´…ç‡ˆï¼šsitemap.xml ä¸æ‡‰è©²åŒ…å«è‹±æ–‡ hreflang
      expect(sitemapContent).not.toContain('hreflang="en"');
    });

    it('should only have zh-TW and x-default hreflang if present', () => {
      if (!sitemapExists || !isRatewiseBuild) {
        console.log('â­ï¸ Skipping: ratewise sitemap.xml not found (generated during build)');
        return;
      }
      const sitemapContent = readFileSync(distSitemapPath, 'utf-8');

      // vite-ssg-sitemap doesn't generate hreflang by default
      const hasHreflang = sitemapContent.includes('hreflang=');
      if (hasHreflang) {
        expect(sitemapContent).toContain('hreflang="zh-TW"');
        expect(sitemapContent).toContain('hreflang="x-default"');

        // ç¢ºèªæ²’æœ‰å…¶ä»–èªè¨€ï¼ˆen, ja, ko, etc.ï¼‰
        expect(sitemapContent).not.toContain('hreflang="en"');
        expect(sitemapContent).not.toContain('hreflang="ja"');
        expect(sitemapContent).not.toContain('hreflang="ko"');
        expect(sitemapContent).not.toContain('hreflang="zh-CN"');
      } else {
        // æ²’æœ‰ hreflang ä¹Ÿæ˜¯å¯æ¥å—çš„ï¼ˆhreflang ç”± HTML meta tags æä¾›ï¼‰
        console.log('â„¹ï¸ sitemap.xml ä¸åŒ…å« hreflangï¼ˆç”± HTML meta tags æä¾›ï¼‰');
      }
    });

    it('should have correct xhtml:link elements if hreflang is present', () => {
      if (!sitemapExists || !isRatewiseBuild) {
        console.log('â­ï¸ Skipping: ratewise sitemap.xml not found (generated during build)');
        return;
      }
      const sitemapContent = readFileSync(distSitemapPath, 'utf-8');

      // vite-ssg-sitemap doesn't generate xhtml:link by default
      const xlinkMatches = sitemapContent.match(/<xhtml:link/g);
      if (xlinkMatches) {
        // å¦‚æœæœ‰ xhtml:linkï¼Œæª¢æŸ¥æ•¸é‡æ­£ç¢º
        // 20 æ¢ URL * 2 èªè¨€ = 40
        expect(xlinkMatches.length).toBe(40);
      } else {
        // æ²’æœ‰ xhtml:link ä¹Ÿæ˜¯å¯æ¥å—çš„ï¼ˆhreflang ç”± HTML meta tags æä¾›ï¼‰
        console.log('â„¹ï¸ sitemap.xml ä¸åŒ…å« xhtml:linkï¼ˆç”± HTML meta tags æä¾›ï¼‰');
      }
    });
  });

  describe('ğŸ”´ RED: SEOHelmet.tsx Hreflang é…ç½®', () => {
    const seoHelmetPath = resolve(__dirname, 'components/SEOHelmet.tsx');
    const seoHelmetContent = readFileSync(seoHelmetPath, 'utf-8');

    it('should NOT have English locale in fallback alternates', () => {
      // ğŸ”´ ç´…ç‡ˆï¼šfallback alternates ä¸æ‡‰è©²åŒ…å«è‹±æ–‡
      const alternatesMatch = /const alternatesToRender[\s\S]*?\[[\s\S]*?\];/.exec(
        seoHelmetContent,
      );
      expect(alternatesMatch).toBeTruthy();

      const alternatesBlock = alternatesMatch![0];

      // ç¢ºèªä¸åŒ…å« 'en', 'en-US', 'en-GB' ç­‰è‹±æ–‡ locale
      expect(alternatesBlock).not.toContain("'en'");
      expect(alternatesBlock).not.toContain('"en"');
      expect(alternatesBlock).not.toContain("'en-US'");
      expect(alternatesBlock).not.toContain('"en-US"');
      expect(alternatesBlock).not.toContain("'en-GB'");
      expect(alternatesBlock).not.toContain('"en-GB"');
    });

    it('should only have x-default and DEFAULT_LOCALE in fallback alternates', () => {
      // ğŸ”´ ç´…ç‡ˆï¼šç¢ºèª fallback alternates åªæœ‰ x-default å’Œ DEFAULT_LOCALE
      const alternatesMatch = /const alternatesToRender[\s\S]*?\[[\s\S]*?\];/.exec(
        seoHelmetContent,
      );
      expect(alternatesMatch).toBeTruthy();

      const alternatesBlock = alternatesMatch![0];

      // æ‡‰è©²åŒ…å« x-default å’Œ DEFAULT_LOCALE
      expect(alternatesBlock).toMatch(/'x-default'|"x-default"/);
      expect(alternatesBlock).toMatch(/DEFAULT_LOCALE/);

      // è¨ˆç®— hrefLang çš„æ•¸é‡ï¼ˆæ‡‰è©²åªæœ‰ 2 å€‹ï¼‰
      const hrefLangMatches = alternatesBlock.match(/hrefLang:/g);
      expect(hrefLangMatches?.length).toBe(2);
    });

    it('should not generate og:locale:alternate for the same locale as og:locale', () => {
      // ğŸ”´ ç´…ç‡ˆï¼šæª¢æŸ¥ og:locale:alternate ç”Ÿæˆé‚è¼¯
      // ç•¶åªæœ‰ä¸€ç¨®èªè¨€æ™‚ï¼Œä¸æ‡‰è©²ç”Ÿæˆ og:locale:alternate

      // æœå°‹ og:locale:alternate ç”Ÿæˆä»£ç¢¼
      const ogLocaleAlternateMatch = /<meta[\s\S]*?property="og:locale:alternate"[\s\S]*?\/>/.exec(
        seoHelmetContent,
      );

      // å¦‚æœæ‰¾åˆ° og:locale:alternateï¼Œç¢ºèªæœ‰ filter é‚è¼¯æ’é™¤ä¸»è¦ locale
      if (ogLocaleAlternateMatch) {
        // æª¢æŸ¥æ˜¯å¦æœ‰éæ¿¾é‚è¼¯ï¼ˆfilter æ‰ x-defaultï¼‰
        expect(seoHelmetContent).toContain("hrefLang !== 'x-default'");

        // æª¢æŸ¥æ˜¯å¦æœ‰éæ¿¾ä¸»è¦ locale çš„é‚è¼¯
        // ç•¶ alternates åªæœ‰ x-default å’Œä¸»è¦ locale æ™‚ï¼Œæ‡‰è©²ä¸ç”Ÿæˆ og:locale:alternate
        const filterLogic = /normalizedAlternates[\s\S]*?\.filter[\s\S]*?\.map/.exec(
          seoHelmetContent,
        );
        expect(filterLogic).toBeTruthy();
      }
    });
  });

  describe('ğŸ”´ RED: Hreflang æœ€ä½³å¯¦è¸é©—è­‰', () => {
    it('sitemap.xml and SEOHelmet should have consistent hreflang configuration', () => {
      // Validate SEOHelmet's HTML meta tag hreflang configuration

      const seoHelmetPath = resolve(__dirname, 'components/SEOHelmet.tsx');
      const seoHelmetContent = readFileSync(seoHelmetPath, 'utf-8');

      // SEOHelmet æ‡‰è©²åªæœ‰ x-default å’Œ zh-TW
      expect(seoHelmetContent).toMatch(/hrefLang:\s*DEFAULT_LOCALE/);
      expect(seoHelmetContent).toMatch(/hrefLang:\s*['"]x-default['"]/);

      // SEOHelmet ä¸æ‡‰è©²æœ‰ en
      expect(seoHelmetContent).not.toContain("'en'");
      expect(seoHelmetContent).not.toContain('"en"');

      // sitemap.xml hreflang validation moved to CI pipeline
    });

    it('should follow hreflang best practices: no self-referencing alternate', () => {
      // ğŸ”´ ç´…ç‡ˆï¼šHreflang æœ€ä½³å¯¦è¸ - ä¸»è¦èªè¨€ä¸æ‡‰è©²ä½œç‚º alternate

      const seoHelmetPath = resolve(__dirname, 'components/SEOHelmet.tsx');
      const seoHelmetContent = readFileSync(seoHelmetPath, 'utf-8');

      // æª¢æŸ¥æ˜¯å¦æœ‰é‚è¼¯é¿å…ä¸»è¦ locale æˆç‚º og:locale:alternate
      // ç•¶åªæœ‰ä¸€ç¨®èªè¨€æ™‚ï¼Œæ‡‰è©²ï¼š
      // - og:locale = zh_TW (ä¸»è¦èªè¨€)
      // - ä¸æ‡‰è©²æœ‰ og:locale:alternate = zh_TW

      // Filter x-default and locales matching primary locale
      // 1. hrefLang === 'x-default'
      // 2. hrefLang.replace('-', '_') === ogLocaleï¼ˆä¸»è¦èªè¨€ï¼‰

      // æŸ¥æ‰¾éæ¿¾æ‰èˆ‡ä¸»è¦ locale ç›¸åŒé …ç›®çš„é‚è¼¯
      const filterPattern = /hrefLang\.replace\(['"]-['"],\s*['"]_['"]\)\s*!==\s*ogLocale/;
      const hasOgLocaleFilter = filterPattern.test(seoHelmetContent);

      // æ‡‰è©²éæ¿¾æ‰èˆ‡ä¸»è¦ locale ç›¸åŒçš„é …ç›®
      expect(hasOgLocaleFilter).toBe(true);

      // ç¢ºèªä¹Ÿæœ‰éæ¿¾ x-default
      expect(seoHelmetContent).toContain("hrefLang !== 'x-default'");
    });
  });
});
