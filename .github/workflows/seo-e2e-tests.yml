name: SEO E2E Tests

# SEO End-to-End æ¸¬è©¦å·¥ä½œæµ
# åŠŸèƒ½:
# 1. å°ç”Ÿç”¢ç’°å¢ƒåŸ·è¡Œå®Œæ•´ SEO é©—è­‰
# 2. é©—è­‰ HTTP 200ã€Meta Tagsã€Open Graphã€JSON-LD
# 3. é©—è­‰åœ–ç‰‡è³‡æºã€å°¾æ–œç·šä¸€è‡´æ€§ã€è¡Œå‹•è£ç½®å‹å–„æ€§
#
# è§¸ç™¼æ¢ä»¶:
# - Release å·¥ä½œæµç¨‹æˆåŠŸå¾Œè‡ªå‹•åŸ·è¡Œ
# - PR å’Œ main åˆ†æ”¯æ¨é€ï¼ˆå¯é¸ï¼‰
# - æ‰‹å‹•è§¸ç™¼ (workflow_dispatch)
# - æ¯æ—¥å®šæ™‚æª¢æŸ¥ (UTC 00:00 = å°åŒ— 08:00)
#
# å»ºç«‹æ™‚é–“: 2025-12-10T00:00:00+08:00
# ä¾æ“š: [SEO Best Practices 2025][Playwright Best Practices]

on:
  # Release æˆåŠŸå¾Œè‡ªå‹•åŸ·è¡Œ
  workflow_run:
    workflows: ['Release']
    types:
      - completed

  # PR å’Œ main åˆ†æ”¯æ¨é€æ™‚åŸ·è¡Œï¼ˆå¯é¸ï¼Œé¿å…éåº¦é »ç¹ï¼‰
  # push:
  #   branches: [main]
  # pull_request:

  # æ‰‹å‹•è§¸ç™¼
  workflow_dispatch:

  # æ¯æ—¥å®šæ™‚æª¢æŸ¥ (UTC 00:00 = å°åŒ— 08:00)
  schedule:
    - cron: '0 0 * * *'

env:
  NIHONNAME_BASE_URL: 'https://app.haotool.org/nihonname'

jobs:
  seo-e2e-tests:
    name: SEO E2E Validation
    runs-on: ubuntu-latest
    timeout-minutes: 15

    # åªåœ¨ Release æˆåŠŸæ™‚åŸ·è¡Œ (æˆ–æ‰‹å‹•/å®šæ™‚è§¸ç™¼)
    if: |
      github.event_name == 'workflow_dispatch' ||
      github.event_name == 'schedule' ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.10.0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # ç­‰å¾… Zeabur éƒ¨ç½²å®Œæˆ (ç´„ 2-3 åˆ†é˜)
      - name: Wait for deployment
        if: github.event_name == 'workflow_run'
        run: |
          echo "â³ ç­‰å¾… Zeabur éƒ¨ç½²å®Œæˆ..."
          sleep 180

      - name: Install Playwright browsers
        run: pnpm --filter @app/nihonname exec playwright install chromium --with-deps

      - name: Run SEO E2E tests
        id: seo_tests
        run: |
          echo "ğŸ” åŸ·è¡Œ NihonName SEO E2E æ¸¬è©¦"
          echo "ğŸ“ Base URL: ${{ env.NIHONNAME_BASE_URL }}"
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          pnpm --filter @app/nihonname test:e2e tests/e2e/seo-validation.spec.ts
        continue-on-error: true

      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-seo-report
          path: apps/nihonname/playwright-report/
          retention-days: 30

      - name: Check test results
        run: |
          TEST_RESULT="${{ steps.seo_tests.outcome }}"

          echo "ğŸ“Š SEO E2E æ¸¬è©¦çµæœ"
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"

          if [ "$TEST_RESULT" = "success" ]; then
            echo "âœ… SEO E2E æ¸¬è©¦é€šéï¼"
            echo ""
            echo "é©—è­‰é …ç›®:"
            echo "âœ“ HTTP 200 ç‹€æ…‹ (8 å€‹é é¢)"
            echo "âœ“ Meta Tags (title, description, canonical)"
            echo "âœ“ Open Graph Tags"
            echo "âœ“ JSON-LD Structured Data"
            echo "âœ“ åœ–ç‰‡è³‡æº (OG image, favicon, apple-touch-icon)"
            echo "âœ“ å°¾æ–œç·šä¸€è‡´æ€§"
            echo "âœ“ æ•ˆèƒ½ (<3s è¼‰å…¥æ™‚é–“)"
            echo "âœ“ è¡Œå‹•è£ç½®å‹å–„æ€§"
          else
            echo "âŒ SEO E2E æ¸¬è©¦å¤±æ•—ï¼"
            echo ""
            echo "å¯èƒ½çš„åŸå› :"
            echo "1. Zeabur éƒ¨ç½²å°šæœªå®Œæˆ"
            echo "2. æŸå€‹é é¢è¿”å›é 200 ç‹€æ…‹"
            echo "3. Meta tags æˆ– Open Graph é…ç½®ä¸æ­£ç¢º"
            echo "4. JSON-LD structured data æ ¼å¼éŒ¯èª¤"
            echo "5. åœ–ç‰‡è³‡æºç„¡æ³•è¨ªå•"
            echo "6. å°¾æ–œç·šæ ¼å¼ä¸ä¸€è‡´"
            echo ""
            echo "è«‹æŸ¥çœ‹ Playwright å ±å‘Šäº†è§£è©³ç´°è³‡è¨Š"
            exit 1
          fi

      - name: Comment PR with test results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const testResult = '${{ steps.seo_tests.outcome }}';
            const status = testResult === 'success' ? 'âœ… é€šé' : 'âŒ å¤±æ•—';
            const emoji = testResult === 'success' ? 'âœ…' : 'âŒ';

            const comment = `## ğŸ” SEO E2E æ¸¬è©¦å ±å‘Š

            **æ¸¬è©¦çµæœ**: ${status}

            ### æ¸¬è©¦ç¯„åœ
            - ${emoji} HTTP 200 ç‹€æ…‹ (8 å€‹é é¢)
            - ${emoji} Meta Tags (title, description, canonical)
            - ${emoji} Open Graph Tags
            - ${emoji} JSON-LD Structured Data
            - ${emoji} åœ–ç‰‡è³‡æº (OG image, favicon, apple-touch-icon)
            - ${emoji} å°¾æ–œç·šä¸€è‡´æ€§
            - ${emoji} æ•ˆèƒ½ (<3s è¼‰å…¥æ™‚é–“)
            - ${emoji} è¡Œå‹•è£ç½®å‹å–„æ€§

            ${testResult !== 'success' ? 'âš ï¸ **è«‹æŸ¥çœ‹ Playwright å ±å‘Šäº†è§£å¤±æ•—åŸå› **' : ''}

            ğŸ“Š [æŸ¥çœ‹å®Œæ•´ Playwright å ±å‘Š](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
