name: SEO Production Validation

# ç”Ÿç”¢ç’°å¢ƒ SEO çµ±ä¸€é©—è­‰å·¥ä½œæµ
# åŠŸèƒ½:
# 1. å¥åº·æª¢æŸ¥: HTTP 200ã€sitemap.xmlã€robots.txtã€llms.txt
# 2. E2E æ¸¬è©¦: Meta Tagsã€Open Graphã€JSON-LDã€åœ–ç‰‡è³‡æº
# 3. æ”¯æ´æ‰€æœ‰ apps: ratewise + nihonname + haotool
#
# è§¸ç™¼æ¢ä»¶:
# - Release æˆåŠŸå¾Œè‡ªå‹•åŸ·è¡Œ
# - æ‰‹å‹•è§¸ç™¼ (workflow_dispatch)
# - æ¯æ—¥å®šæ™‚æª¢æŸ¥ (UTC 00:00 = å°åŒ— 08:00)
#
# æ›´æ–°æ™‚é–“: 2026-01-29
# ä¾æ“š: [SEO Best Practices 2025][Linus: æ¶ˆé™¤ç‰¹æ®Šæƒ…æ³]

on:
  workflow_run:
    workflows: ['Release']
    types:
      - completed

  workflow_dispatch:

  schedule:
    - cron: '0 0 * * *'

permissions:
  contents: read

env:
  RATEWISE_BASE_URL: 'https://app.haotool.org/ratewise'
  NIHONNAME_BASE_URL: 'https://app.haotool.org/nihonname'
  HAOTOOL_BASE_URL: 'https://app.haotool.org'

jobs:
  health-check:
    name: SEO Health Check
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read

    if: |
      github.event_name == 'workflow_dispatch' ||
      github.event_name == 'schedule' ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'

      - name: Wait for deployment
        if: github.event_name == 'workflow_run'
        run: |
          echo "â³ ç­‰å¾… Zeabur éƒ¨ç½²å®Œæˆ..."
          sleep 180

      - name: Run All Apps SEO Health Check
        run: node scripts/verify-all-apps.mjs

  e2e-validation:
    name: SEO E2E Validation
    needs: health-check
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.10.0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install Playwright browsers
        run: pnpm --filter @app/nihonname exec playwright install chromium --with-deps

      - name: Run NihonName SEO E2E tests
        id: seo_tests
        run: |
          echo "ðŸ” åŸ·è¡Œ NihonName SEO E2E æ¸¬è©¦"
          echo "ðŸ“ Base URL: ${{ env.NIHONNAME_BASE_URL }}"
          pnpm --filter @app/nihonname test:e2e tests/e2e/seo-validation.spec.ts
        continue-on-error: true

      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: seo-e2e-report
          path: apps/nihonname/playwright-report/
          retention-days: 30

      - name: Check test results
        run: |
          TEST_RESULT="${{ steps.seo_tests.outcome }}"
          if [ "$TEST_RESULT" != "success" ]; then
            echo "âŒ SEO E2E æ¸¬è©¦å¤±æ•—"
            exit 1
          fi
          echo "âœ… SEO E2E æ¸¬è©¦é€šéŽ"

  summary:
    name: Generate Summary
    needs: [health-check, e2e-validation]
    runs-on: ubuntu-latest
    if: always()
    permissions:
      contents: read

    steps:
      - name: Generate workflow summary
        run: |
          echo "## ðŸ” SEO Production Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Health Check | ${{ needs.health-check.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| E2E Validation | ${{ needs.e2e-validation.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Time**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
