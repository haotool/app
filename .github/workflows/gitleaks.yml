# Gitleaks å¯†é‘°æƒæå·¥ä½œæµç¨‹
# ç”¨æ–¼æª¢æ¸¬ç¨‹å¼ç¢¼ä¸­çš„å¯†é‘°ã€API é‡‘é‘°ã€å¯†ç¢¼ç­‰æ•æ„Ÿè³‡è¨Š
#
# æœ€å¾Œæ›´æ–°: 2025-12-25T00:06:00+08:00
# ä¾æ“š: [context7:gitleaks/gitleaks:2025-12-24]
# æ³¨æ„: ä½¿ç”¨ CLI ç‰ˆæœ¬è€Œé Actionï¼Œé¿å…çµ„ç¹”å¸³è™Ÿéœ€è¦ä»˜è²» license

name: Gitleaks Secret Scan

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

jobs:
  gitleaks:
    name: ğŸ”’ Secret Detection
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # éœ€è¦å®Œæ•´æ­·å²è¨˜éŒ„é€²è¡Œæ·±åº¦æƒæ

      - name: ğŸ”§ Install Gitleaks
        run: |
          # å®‰è£æœ€æ–°ç‰ˆ gitleaks
          wget -q https://github.com/gitleaks/gitleaks/releases/download/v8.18.4/gitleaks_8.18.4_linux_x64.tar.gz
          tar -xzf gitleaks_8.18.4_linux_x64.tar.gz
          chmod +x gitleaks
          sudo mv gitleaks /usr/local/bin/
          gitleaks version

      - name: ğŸ” Run Gitleaks
        run: |
          # åŸ·è¡Œ gitleaks æƒæ
          gitleaks git --config .gitleaks.toml --report-path gitleaks-report.sarif --report-format sarif --verbose --log-opts="--all" || EXIT_CODE=$?

          # è¼¸å‡ºçµæœ
          if [ -f gitleaks-report.sarif ]; then
            echo "ğŸ“Š Gitleaks å ±å‘Šå·²ç”Ÿæˆ"
            # æª¢æŸ¥æ˜¯å¦æœ‰ç™¼ç¾
            if grep -q '"results":\[\]' gitleaks-report.sarif; then
              echo "âœ… æœªç™¼ç¾å¯†é‘°æ´©éœ²"
            else
              echo "::warning::âš ï¸ Gitleaks ç™¼ç¾æ½›åœ¨å¯†é‘°ï¼Œè«‹æª¢æŸ¥å ±å‘Š"
            fi
          fi

          # ä¸å› ç‚ºç™¼ç¾å¯†é‘°è€Œå¤±æ•—ï¼ˆåƒ…è­¦å‘Šï¼‰
          exit 0

      - name: ğŸ“Š Upload SARIF results
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: gitleaks-report.sarif
        continue-on-error: true
