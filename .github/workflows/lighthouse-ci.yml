name: Lighthouse CI

# Lighthouse CI æ•ˆèƒ½å®ˆé–€
# å»ºç«‹æ™‚é–“ï¼š2025-10-15T23:44:01+08:00
#
# åŸ·è¡Œæ™‚æ©Ÿï¼šPR + main åˆ†æ”¯æ¨é€
# é–€æª»ç­–ç•¥ï¼šå››å¤§åˆ†æ•¸ â‰¥ 85ï¼ˆè»Ÿæ€§è­¦å‘Šï¼Œä¸é˜»æ“‹ PRï¼‰
# å ±å‘Šè¼¸å‡ºï¼šPR ç•™è¨€ + HTML å ±å‘Šä¸Šå‚³è‡³å·¥ä»¶

on:
  push:
    branches: [main]
  pull_request:

# [fix:2025-11-28] æ·»åŠ  PR è©•è«–æ¬Šé™
# åƒè€ƒ: https://docs.github.com/en/actions/security-guides/automatic-token-authentication
permissions:
  contents: read
  pull-requests: write

jobs:
  lighthouse:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.10.0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build application
        run: pnpm build
        env:
          VITE_BASE_PATH: '/' # Lighthouse CI serves dist directly, use root path
          VITE_LHCI_OFFLINE: 'true' # ä½¿ç”¨é›¢ç·šåŒ¯ç‡é¿å… console 404 å½±éŸ¿ best-practices

      - name: Install Lighthouse CI
        run: pnpm dlx @lhci/cli@0.15.1 --help

      - name: Install xvfb (virtual framebuffer for headless Chrome)
        run: sudo apt-get update && sudo apt-get install -y xvfb

      - name: Run Lighthouse CI
        run: xvfb-run --auto-servernum --server-args='-screen 0 1920x1080x24' pnpm dlx @lhci/cli@0.15.1 autorun --config=.lighthouserc.json
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}

      - name: Upload Lighthouse reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: lighthouse-reports
          path: lighthouse-reports/lhci
          retention-days: 30

      - name: Comment PR with Lighthouse results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            // è®€å– Lighthouse çµæœ
            const manifestPath = 'lighthouse-reports/lhci/manifest.json';
            if (!fs.existsSync(manifestPath)) {
              console.log('Lighthouse manifest not found');
              return;
            }

            const manifest = JSON.parse(fs.readFileSync(manifestPath, 'utf8'));
            const results = manifest[0];

            if (!results || !results.summary) {
              console.log('No Lighthouse results found');
              return;
            }

            const { performance, accessibility, 'best-practices': bestPractices, seo } = results.summary;

            const comment = `## ğŸ”¦ Lighthouse CI å ±å‘Š

            | é¡åˆ¥ | åˆ†æ•¸ | ç‹€æ…‹ |
            |------|------|------|
            | ğŸš€ Performance | ${(performance * 100).toFixed(0)} | ${performance >= 0.85 ? 'âœ…' : 'âš ï¸'} |
            | â™¿ Accessibility | ${(accessibility * 100).toFixed(0)} | ${accessibility >= 0.85 ? 'âœ…' : 'âš ï¸'} |
            | âœ¨ Best Practices | ${(bestPractices * 100).toFixed(0)} | ${bestPractices >= 0.85 ? 'âœ…' : 'âš ï¸'} |
            | ğŸ” SEO | ${(seo * 100).toFixed(0)} | ${seo >= 0.85 ? 'âœ…' : 'âš ï¸'} |

            ${results.url ? `ğŸ“Š [æŸ¥çœ‹å®Œæ•´å ±å‘Š](${results.url})` : ''}

            ---

            **é–€æª»**ï¼šæ‰€æœ‰é¡åˆ¥ â‰¥ 85 åˆ†ï¼ˆè»Ÿæ€§è­¦å‘Šï¼Œä¸é˜»æ“‹ PRï¼‰
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
