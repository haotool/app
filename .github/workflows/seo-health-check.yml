name: SEO Health Check

# ç”Ÿç”¢ç’°å¢ƒ SEO å¥åº·æª¢æŸ¥
# åŠŸèƒ½:
# 1. é©—è­‰æ‰€æœ‰é é¢è¿”å› 200
# 2. é©—è­‰ sitemap.xml, robots.txt, llms.txt é…ç½®æ­£ç¢º
# 3. é©—è­‰ hreflang é…ç½®ä¸€è‡´æ€§
# 4. æ”¯æ´å¤šå°ˆæ¡ˆï¼šratewise + nihonname
#
# è§¸ç™¼æ¢ä»¶:
# - Release å·¥ä½œæµç¨‹æˆåŠŸå¾Œè‡ªå‹•åŸ·è¡Œ
# - æ‰‹å‹•è§¸ç™¼ (workflow_dispatch)
# - æ¯æ—¥å®šæ™‚æª¢æŸ¥ (UTC 00:00 = å°åŒ— 08:00)
#
# å»ºç«‹æ™‚é–“: 2025-11-30T15:50:00+08:00
# æ›´æ–°æ™‚é–“: 2025-12-05T00:30:00+08:00
# ä¾æ“š: [moss.sh/deployment/health-checks][SEO Best Practices 2025]

on:
  # Release æˆåŠŸå¾Œè‡ªå‹•åŸ·è¡Œ
  workflow_run:
    workflows: ['Release']
    types:
      - completed

  # æ‰‹å‹•è§¸ç™¼
  workflow_dispatch:

  # æ¯æ—¥å®šæ™‚æª¢æŸ¥ (UTC 00:00 = å°åŒ— 08:00)
  schedule:
    - cron: '0 0 * * *'

env:
  RATEWISE_BASE_URL: 'https://app.haotool.org/ratewise'
  NIHONNAME_BASE_URL: 'https://app.haotool.org/nihonname'

jobs:
  seo-health-check:
    name: SEO Health Check
    runs-on: ubuntu-latest

    # åªåœ¨ Release æˆåŠŸæ™‚åŸ·è¡Œ (æˆ–æ‰‹å‹•/å®šæ™‚è§¸ç™¼)
    if: |
      github.event_name == 'workflow_dispatch' ||
      github.event_name == 'schedule' ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'

      # ç­‰å¾… Zeabur éƒ¨ç½²å®Œæˆ (ç´„ 2-3 åˆ†é˜)
      - name: Wait for deployment
        if: github.event_name == 'workflow_run'
        run: |
          echo "â³ ç­‰å¾… Zeabur éƒ¨ç½²å®Œæˆ..."
          sleep 180

      # RateWise SEO æª¢æŸ¥
      - name: Run RateWise SEO health check
        id: ratewise_check
        run: |
          node scripts/verify-production-seo.mjs --base-url=${{ env.RATEWISE_BASE_URL }}
        continue-on-error: true

      # NihonName SEO æª¢æŸ¥
      - name: Run NihonName SEO health check
        id: nihonname_check
        run: |
          echo "ğŸ” NihonName ç”Ÿç”¢ç’°å¢ƒ SEO å¥åº·æª¢æŸ¥"
          echo "ğŸ“ Base URL: ${{ env.NIHONNAME_BASE_URL }}"
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"

          # å®šç¾© NihonName çš„ SEO è·¯å¾‘
          # [SEO:2025-12-10] æ‰€æœ‰è·¯å¾‘çµ±ä¸€ä½¿ç”¨å°¾æ–œç·šæ ¼å¼
          # ç¬¦åˆ 2025 SEO æœ€ä½³å¯¦è¸ï¼šä¸€è‡´æ€§ > é¸æ“‡
          NIHONNAME_PATHS=(
            "/"
            "/about/"
            "/guide/"
            "/faq/"
            "/history/"
            "/history/kominka/"
            "/history/shimonoseki/"
            "/history/san-francisco/"
          )

          SEO_FILES=(
            "/sitemap.xml"
            "/robots.txt"
            "/llms.txt"
            "/og-image.png"
          )

          FAILED=0

          echo ""
          echo "ğŸ“„ é é¢ HTTP ç‹€æ…‹æª¢æŸ¥:"
          for path in "${NIHONNAME_PATHS[@]}"; do
            url="${{ env.NIHONNAME_BASE_URL }}${path}"
            # ä½¿ç”¨ -L è·Ÿéš¨é‡å®šå‘ï¼Œç²å–æœ€çµ‚ç‹€æ…‹ç¢¼
            status=$(curl -s -o /dev/null -w "%{http_code}" -L "$url")
            if [ "$status" = "200" ]; then
              echo "âœ“ ${path} â†’ ${status}"
            else
              echo "âœ— ${path} â†’ ${status}"
              FAILED=1
            fi
          done

          echo ""
          echo "ğŸ“ SEO é…ç½®æ–‡ä»¶æª¢æŸ¥:"
          for file in "${SEO_FILES[@]}"; do
            url="${{ env.NIHONNAME_BASE_URL }}${file}"
            status=$(curl -s -o /dev/null -w "%{http_code}" "$url")
            if [ "$status" = "200" ]; then
              echo "âœ“ ${file} â†’ ${status}"
            else
              echo "âœ— ${file} â†’ ${status}"
              FAILED=1
            fi
          done

          echo ""
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          if [ "$FAILED" = "1" ]; then
            echo "âŒ NihonName SEO å¥åº·æª¢æŸ¥å¤±æ•—ï¼"
            exit 1
          else
            echo "âœ… NihonName SEO å¥åº·æª¢æŸ¥é€šéï¼"
          fi
        continue-on-error: true

      - name: Check results
        run: |
          RATEWISE_OK="${{ steps.ratewise_check.outcome }}"
          NIHONNAME_OK="${{ steps.nihonname_check.outcome }}"

          echo "ğŸ“Š SEO å¥åº·æª¢æŸ¥çµæœæ‘˜è¦"
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"

          if [ "$RATEWISE_OK" = "success" ]; then
            echo "âœ… RateWise: é€šé"
          else
            echo "âŒ RateWise: å¤±æ•—"
          fi

          if [ "$NIHONNAME_OK" = "success" ]; then
            echo "âœ… NihonName: é€šé"
          else
            echo "âŒ NihonName: å¤±æ•—"
          fi

          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"

          if [ "$RATEWISE_OK" != "success" ] || [ "$NIHONNAME_OK" != "success" ]; then
            echo ""
            echo "âŒ éƒ¨åˆ† SEO å¥åº·æª¢æŸ¥å¤±æ•—ï¼"
            echo ""
            echo "å¯èƒ½çš„åŸå› :"
            echo "1. Zeabur éƒ¨ç½²å°šæœªå®Œæˆ"
            echo "2. æŸå€‹é é¢è¿”å›é 200 ç‹€æ…‹"
            echo "3. sitemap.xml/robots.txt/llms.txt é…ç½®ä¸æ­£ç¢º"
            echo ""
            echo "è«‹æª¢æŸ¥:"
            echo "- ${{ env.RATEWISE_BASE_URL }}/sitemap.xml"
            echo "- ${{ env.NIHONNAME_BASE_URL }}/sitemap.xml"
            exit 1
          else
            echo ""
            echo "âœ… æ‰€æœ‰ SEO å¥åº·æª¢æŸ¥é€šéï¼"
          fi
