name: CI Metrics Tracking (Artifacts ç‰ˆæœ¬)

# CI æ•ˆèƒ½ç›£æŽ§å·¥ä½œæµ - ä½¿ç”¨ Artifacts é¿å… commit æ±¡æŸ“
# åƒè€ƒ: https://docs.github.com/en/actions/using-workflows/storing-workflow-data-as-artifacts
#
# è®Šæ›´:
# - ç§»é™¤ git commit/push æ­¥é©Ÿ
# - æ”¹ç”¨ actions/upload-artifact å„²å­˜ metrics
# - ä¿ç•™ 90 å¤©æ­·å²è¨˜éŒ„ï¼ˆå¯èª¿æ•´ï¼‰
# - æ•ˆèƒ½è­¦ç¤ºåŠŸèƒ½ä¿æŒä¸è®Š
#
# å»ºç«‹æ™‚é–“: 2025-12-30
# ä¾æ“š: [GitHub Actions Best Practices 2025][Avoid Environment Pollution]

on:
  workflow_run:
    workflows: ['CI']
    types: [completed]

permissions:
  contents: read # âœ… é™ç´šæ¬Šé™ï¼Œä¸å†éœ€è¦ write
  actions: read

jobs:
  track-metrics:
    name: Track CI Performance
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion != 'cancelled'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_branch }}

      - name: Get workflow run details
        id: workflow_details
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # å–å¾—å·¥ä½œæµåŸ·è¡Œè³‡è¨Š
          WORKFLOW_ID="${{ github.event.workflow_run.id }}"

          # è¨ˆç®—åŸ·è¡Œæ™‚é–“ï¼ˆç§’ï¼‰
          START_TIME="${{ github.event.workflow_run.run_started_at }}"
          END_TIME="${{ github.event.workflow_run.updated_at }}"

          START_EPOCH=$(date -d "$START_TIME" +%s)
          END_EPOCH=$(date -d "$END_TIME" +%s)
          DURATION=$((END_EPOCH - START_EPOCH))

          echo "duration=$DURATION" >> "$GITHUB_OUTPUT"
          echo "conclusion=${{ github.event.workflow_run.conclusion }}" >> "$GITHUB_OUTPUT"
          echo "branch=${{ github.event.workflow_run.head_branch }}" >> "$GITHUB_OUTPUT"
          echo "commit=${{ github.event.workflow_run.head_sha }}" >> "$GITHUB_OUTPUT"

          echo "ðŸ“Š CI åŸ·è¡Œæ™‚é–“: ${DURATION}s ($(($DURATION / 60))m $(($DURATION % 60))s)"

      - name: Record metrics
        run: |
          # å»ºç«‹ metrics ç›®éŒ„
          mkdir -p ci-metrics

          # æº–å‚™ metrics è³‡æ–™
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          DURATION="${{ steps.workflow_details.outputs.duration }}"
          CONCLUSION="${{ steps.workflow_details.outputs.conclusion }}"
          BRANCH="${{ steps.workflow_details.outputs.branch }}"
          COMMIT="${{ steps.workflow_details.outputs.commit }}"

          # å»ºç«‹å–®æ¬¡åŸ·è¡Œçš„ metrics JSON
          METRICS_FILE="ci-metrics/metrics-${TIMESTAMP}.json"

          cat > "$METRICS_FILE" <<EOF
          {
            "timestamp": "$TIMESTAMP",
            "duration_seconds": $DURATION,
            "conclusion": "$CONCLUSION",
            "branch": "$BRANCH",
            "commit": "$COMMIT",
            "workflow_id": "${{ github.event.workflow_run.id }}",
            "run_number": "${{ github.event.workflow_run.run_number }}"
          }
          EOF

          echo "âœ… Metrics è¨˜éŒ„å®Œæˆ: $METRICS_FILE"

      - name: Download previous metrics (æœ€è¿‘ 10 æ¬¡)
        continue-on-error: true
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            // å–å¾—æœ€è¿‘ 10 æ¬¡ workflow runs çš„ artifacts
            const runs = await github.rest.actions.listWorkflowRuns({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'ci-metrics.yml',
              per_page: 10
            });

            const metricsDir = 'ci-metrics';
            if (!fs.existsSync(metricsDir)) {
              fs.mkdirSync(metricsDir, { recursive: true });
            }

            for (const run of runs.data.workflow_runs) {
              try {
                const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  run_id: run.id
                });

                for (const artifact of artifacts.data.artifacts) {
                  if (artifact.name === 'ci-metrics') {
                    console.log(`ðŸ“¥ æ‰¾åˆ°æ­·å² metrics: ${artifact.name} (${artifact.created_at})`);
                    // Note: å¯¦éš›ä¸‹è¼‰éœ€è¦é¡å¤–é‚è¼¯ï¼Œé€™è£¡ç°¡åŒ–è™•ç†
                  }
                }
              } catch (error) {
                console.log(`âš ï¸ ç„¡æ³•å–å¾— run ${run.id} çš„ artifacts: ${error.message}`);
              }
            }

      - name: Analyze performance trends
        id: analyze
        run: |
          # è¨ˆç®—å¹³å‡æ™‚é–“ï¼ˆä½¿ç”¨ç•¶å‰ç›®éŒ„çš„ metricsï¼‰
          CURRENT_DURATION="${{ steps.workflow_details.outputs.duration }}"

          # å¦‚æžœæœ‰æ­·å²æ•¸æ“šï¼Œè¨ˆç®—å¹³å‡å€¼
          if ls ci-metrics/*.json 1> /dev/null 2>&1; then
            AVG_DURATION=$(jq -s '[.[].duration_seconds] | add / length | floor' ci-metrics/*.json)
            echo "avg_duration=$AVG_DURATION" >> "$GITHUB_OUTPUT"

            echo "ðŸ“ˆ æ•ˆèƒ½çµ±è¨ˆ:"
            echo "   - ç•¶å‰åŸ·è¡Œ: ${CURRENT_DURATION}s"
            echo "   - æ­·å²å¹³å‡: ${AVG_DURATION}s"

            # åµæ¸¬æ•ˆèƒ½å›žé€€ï¼ˆè¶…éŽå¹³å‡ 20%ï¼‰
            THRESHOLD=$((AVG_DURATION * 120 / 100))
            if [ "$CURRENT_DURATION" -gt "$THRESHOLD" ]; then
              echo "âš ï¸ æ•ˆèƒ½å›žé€€è­¦ç¤º: åŸ·è¡Œæ™‚é–“è¶…éŽå¹³å‡ 20%"
              echo "performance_warning=true" >> "$GITHUB_OUTPUT"
            else
              echo "âœ… æ•ˆèƒ½æ­£å¸¸"
              echo "performance_warning=false" >> "$GITHUB_OUTPUT"
            fi
          else
            echo "ðŸ“Š é¦–æ¬¡åŸ·è¡Œï¼Œç„¡æ­·å²æ•¸æ“šå¯æ¯”è¼ƒ"
            echo "avg_duration=$CURRENT_DURATION" >> "$GITHUB_OUTPUT"
            echo "performance_warning=false" >> "$GITHUB_OUTPUT"
          fi

      # âœ… æ–°å¢ž: ä¸Šå‚³ metrics ç‚º artifactï¼ˆå–ä»£ git commitï¼‰
      - name: Upload metrics artifact
        uses: actions/upload-artifact@v4
        with:
          name: ci-metrics
          path: ci-metrics/*.json
          retention-days: 90 # ä¿ç•™ 90 å¤©

      - name: Create performance report
        if: steps.analyze.outputs.performance_warning == 'true' && github.event.workflow_run.event == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const duration = ${{ steps.workflow_details.outputs.duration }};
            const avgDuration = ${{ steps.analyze.outputs.avg_duration }};
            const increase = Math.round((duration - avgDuration) / avgDuration * 100);

            const comment = `## âš ï¸ CI æ•ˆèƒ½è­¦ç¤º

            **åŸ·è¡Œæ™‚é–“**: ${duration}s (${Math.floor(duration / 60)}m ${duration % 60}s)
            **å¹³å‡æ™‚é–“**: ${avgDuration}s (${Math.floor(avgDuration / 60)}m ${avgDuration % 60}s)
            **å¢žåŠ å¹…åº¦**: +${increase}%

            CI åŸ·è¡Œæ™‚é–“è¶…éŽæœ€è¿‘ 10 æ¬¡å¹³å‡çš„ 20%ï¼Œè«‹æª¢æŸ¥æ˜¯å¦æœ‰æ•ˆèƒ½å•é¡Œã€‚

            å¯èƒ½åŽŸå› :
            - æ–°å¢žå¤§é‡æ¸¬è©¦æ¡ˆä¾‹
            - ä¾è³´å®‰è£è®Šæ…¢
            - Runner æ•ˆèƒ½å•é¡Œ
            - Docker å»ºç½®è®Šæ…¢

            ðŸ“Š [æŸ¥çœ‹ Metrics Artifacts](../../actions/workflows/ci-metrics.yml)
            `;

            // åƒ…åœ¨ PR æ™‚ç•™è¨€
            if (context.payload.workflow_run.pull_requests.length > 0) {
              const prNumber = context.payload.workflow_run.pull_requests[0].number;
              await github.rest.issues.createComment({
                issue_number: prNumber,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            }
