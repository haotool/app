name: CI Metrics Tracking

# CI æ•ˆèƒ½ç›£æŽ§å·¥ä½œæµ
# åŠŸèƒ½:
# 1. è¿½è¹¤ä¸» CI å·¥ä½œæµçš„åŸ·è¡Œæ™‚é–“
# 2. è¨˜éŒ„å„ job çš„åŸ·è¡Œæ™‚é•·
# 3. åµæ¸¬æ•ˆèƒ½å›žé€€ï¼ˆåŸ·è¡Œæ™‚é–“ç•°å¸¸å¢žåŠ ï¼‰
# 4. ç”¢ç”Ÿæ•ˆèƒ½è¶¨å‹¢å ±å‘Š
#
# å»ºç«‹æ™‚é–“: 2025-12-11T03:00:00+08:00
# ä¾æ“š: [GitHub Actions Optimization 2025][CI Performance Best Practices]

on:
  workflow_run:
    workflows: ['CI']
    types: [completed]

permissions:
  contents: write
  actions: read

jobs:
  track-metrics:
    name: Track CI Performance
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion != 'cancelled'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_branch }}

      - name: Get workflow run details
        id: workflow_details
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # å–å¾—å·¥ä½œæµåŸ·è¡Œè³‡è¨Š
          WORKFLOW_ID="${{ github.event.workflow_run.id }}"

          # è¨ˆç®—åŸ·è¡Œæ™‚é–“ï¼ˆç§’ï¼‰
          START_TIME="${{ github.event.workflow_run.run_started_at }}"
          END_TIME="${{ github.event.workflow_run.updated_at }}"

          START_EPOCH=$(date -d "$START_TIME" +%s)
          END_EPOCH=$(date -d "$END_TIME" +%s)
          DURATION=$((END_EPOCH - START_EPOCH))

          echo "duration=$DURATION" >> "$GITHUB_OUTPUT"
          echo "conclusion=${{ github.event.workflow_run.conclusion }}" >> "$GITHUB_OUTPUT"
          echo "branch=${{ github.event.workflow_run.head_branch }}" >> "$GITHUB_OUTPUT"
          echo "commit=${{ github.event.workflow_run.head_sha }}" >> "$GITHUB_OUTPUT"

          echo "ðŸ“Š CI åŸ·è¡Œæ™‚é–“: ${DURATION}s ($(($DURATION / 60))m $(($DURATION % 60))s)"

      - name: Record metrics
        run: |
          # å»ºç«‹ metrics ç›®éŒ„
          mkdir -p docs/dev

          # æº–å‚™ metrics è³‡æ–™
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          DURATION="${{ steps.workflow_details.outputs.duration }}"
          CONCLUSION="${{ steps.workflow_details.outputs.conclusion }}"
          BRANCH="${{ steps.workflow_details.outputs.branch }}"
          COMMIT="${{ steps.workflow_details.outputs.commit }}"

          # å»ºç«‹æˆ–æ›´æ–° metrics JSON
          METRICS_FILE="docs/dev/ci-metrics.json"

          if [ ! -f "$METRICS_FILE" ]; then
            echo '{"runs": []}' > "$METRICS_FILE"
          fi

          # æ–°å¢žè¨˜éŒ„
          jq --arg ts "$TIMESTAMP" \
             --arg dur "$DURATION" \
             --arg conc "$CONCLUSION" \
             --arg br "$BRANCH" \
             --arg comm "$COMMIT" \
             '.runs += [{
               "timestamp": $ts,
               "duration_seconds": ($dur | tonumber),
               "conclusion": $conc,
               "branch": $br,
               "commit": $comm
             }] | .runs |= sort_by(.timestamp) | {runs: .runs[-100:]}' \
             "$METRICS_FILE" > "$METRICS_FILE.tmp"

          mv "$METRICS_FILE.tmp" "$METRICS_FILE"

          echo "âœ… Metrics è¨˜éŒ„å®Œæˆ: $METRICS_FILE"

      - name: Analyze performance trends
        id: analyze
        run: |
          METRICS_FILE="docs/dev/ci-metrics.json"

          # è¨ˆç®—æœ€è¿‘ 10 æ¬¡åŸ·è¡Œçš„å¹³å‡æ™‚é–“
          AVG_DURATION=$(jq '[.runs[-10:][].duration_seconds] | add / length | floor' "$METRICS_FILE")
          CURRENT_DURATION="${{ steps.workflow_details.outputs.duration }}"

          echo "avg_duration=$AVG_DURATION" >> "$GITHUB_OUTPUT"

          echo "ðŸ“ˆ æ•ˆèƒ½çµ±è¨ˆ:"
          echo "   - ç•¶å‰åŸ·è¡Œ: ${CURRENT_DURATION}s"
          echo "   - æœ€è¿‘ 10 æ¬¡å¹³å‡: ${AVG_DURATION}s"

          # åµæ¸¬æ•ˆèƒ½å›žé€€ï¼ˆè¶…éŽå¹³å‡ 20%ï¼‰
          THRESHOLD=$((AVG_DURATION * 120 / 100))
          if [ "$CURRENT_DURATION" -gt "$THRESHOLD" ]; then
            echo "âš ï¸ æ•ˆèƒ½å›žé€€è­¦ç¤º: åŸ·è¡Œæ™‚é–“è¶…éŽå¹³å‡ 20%"
            echo "performance_warning=true" >> "$GITHUB_OUTPUT"
          else
            echo "âœ… æ•ˆèƒ½æ­£å¸¸"
            echo "performance_warning=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Commit metrics
        if: success()
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add docs/dev/ci-metrics.json

          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            DURATION="${{ steps.workflow_details.outputs.duration }}"
            git commit -m "chore(ci): record CI metrics - ${DURATION}s"
            git push || echo "Push failed, metrics will be recorded next time"
          fi

      - name: Create performance report
        if: steps.analyze.outputs.performance_warning == 'true' && github.event.workflow_run.event == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const duration = ${{ steps.workflow_details.outputs.duration }};
            const avgDuration = ${{ steps.analyze.outputs.avg_duration }};
            const increase = Math.round((duration - avgDuration) / avgDuration * 100);

            const comment = `## âš ï¸ CI æ•ˆèƒ½è­¦ç¤º

            **åŸ·è¡Œæ™‚é–“**: ${duration}s (${Math.floor(duration / 60)}m ${duration % 60}s)
            **å¹³å‡æ™‚é–“**: ${avgDuration}s (${Math.floor(avgDuration / 60)}m ${avgDuration % 60}s)
            **å¢žåŠ å¹…åº¦**: +${increase}%

            CI åŸ·è¡Œæ™‚é–“è¶…éŽæœ€è¿‘ 10 æ¬¡å¹³å‡çš„ 20%ï¼Œè«‹æª¢æŸ¥æ˜¯å¦æœ‰æ•ˆèƒ½å•é¡Œã€‚

            å¯èƒ½åŽŸå› :
            - æ–°å¢žå¤§é‡æ¸¬è©¦æ¡ˆä¾‹
            - ä¾è³´å®‰è£è®Šæ…¢
            - Runner æ•ˆèƒ½å•é¡Œ
            - Docker å»ºç½®è®Šæ…¢

            ðŸ“Š [æŸ¥çœ‹å®Œæ•´ Metrics](../blob/main/docs/dev/ci-metrics.json)
            `;

            // åƒ…åœ¨ PR æ™‚ç•™è¨€
            if (context.payload.workflow_run.pull_requests.length > 0) {
              const prNumber = context.payload.workflow_run.pull_requests[0].number;
              await github.rest.issues.createComment({
                issue_number: prNumber,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            }
